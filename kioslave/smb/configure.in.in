
AC_ARG_WITH(samba-libs,
[  --with-samba-libs=path  Use Samba-tng libs in 'path'                [search]],
,with_samba_libs=no)

SAMBA_LIBS="";

AC_CACHE_CHECK([for Samba libs], ac_cv_lib_samba,
[
	possible_locations="/usr/local/samba/lib /usr/local/lib /usr/samba/lib /usr/lib /lib /opt/samba/lib"
	if test "x$with_samba_libs" != "xno"; then
		possible_locations="$with_samba_libs $possible_locations"
	fi
	
	for f in $possible_locations
	do
		if test -r $f/libsmb.so -a -r $f/libsamba.so -a -r $f/libnmb.so
		then
			SAMBA_LIBS=$f
			break
		fi
	done

if test "x$SAMBA_LIBS" != "x"
then
	ac_cv_lib_samba=$SAMBA_LIBS
else
	ac_cv_lib_samba="no. Falling back on native code."
fi
])
SAMBA_LIBS="$ac_cv_lib_samba"
AC_SUBST(SAMBA_LIBS)

AC_CACHE_CHECK([for smb.conf file], ac_cv_smb_conf,
[
if test "x$ac_cv_lib_samba" != "xno. Falling back on native code."
then
	found_smb_conf="no"

dnl I wonder if it's worth adding another --with option in kdebase configure
dnl Skip it for now

dnl	if test "x$with_smb_conf" != "xno"; then
dnl		if test -r $with_smb_conf
dnl		then
dnl			found_smb_conf=$with_smb_conf
dnl		else
dnl			echo ""
dnl			echo ""
dnl			echo "Warning: Cannot access $with_smb_conf."
dnl			echo "Reverting to search mode."
dnl			echo ""
dnl			echo -n "checking for smb.conf file... "
dnl		fi
dnl	fi
	
	if test "$found_smb_conf" = "no"
	then
		possible_locations="$ac_cv_lib_samba /usr/local/samba/lib /usr/local/samba /usr/local/samba/etc /usr/samba/lib /usr/samba /usr/samba/etc /etc /usr/local/etc /usr/etc /opt/samba/lib /opt/samba /opt/samba/etc"

		for f in $possible_locations
		do
			if test -r $f/smb.conf
			then
				found_smb_conf=$f/smb.conf
				break
			fi
		done
	fi
	
	if test "$found_smb_conf" != "no"
	then
		ac_cv_smb_conf=$found_smb_conf
	else
		ac_cv_smb_conf="no"
	fi
else
		ac_cv_smb_conf="Using native code, skipping."
fi
])

if test "x$ac_cv_lib_samba" != "xno. Falling back on native code."
then
	if test "$ac_cv_smb_conf" = "no"
	then
		echo ""
		echo "************************************************************"
		echo "Error! Using Samba, but smb.conf file not found."
dnl		echo "Please delete config.cache and use the --with-smb-conf flag,"
dnl		echo "or check your Samba configuration."
		echo "Please check your Samba configuration."
		echo "************************************************************"
		echo ""
dnl		exit
	fi
	config_file="$ac_cv_smb_conf"
	AC_DEFINE_UNQUOTED(SMB_CONF_FILE, "$config_file", [The location of smb.conf file])
	EXTRA_LIBSMB_FLAGS="-L$ac_cv_lib_samba -Wl,-rpath,$ac_cv_lib_samba -lsmb -lsamba -lnmb"
	EXTRA_LIBSMB_ADD="-lsmb -lsamba -lnmb"
	AC_DEFINE_UNQUOTED(USE_SAMBA,1, [Define if Samba-tng should be used in libsmb++])
else
	EXTRA_LIBSMB_FLAGS=""
	EXTRA_LIBSMB_ADD=""
fi

AM_CONDITIONAL(LINKHOOK, test "x$ac_cv_lib_samba" != "xno. Falling back on native code.")

AC_SUBST(EXTRA_LIBSMB_FLAGS)
AC_SUBST(EXTRA_LIBSMB_ADD)

dnl Checks for typedefs,   structures, and compiler characteristics.
dnl AC_CHECK_SIZEOF(char,1)
dnl AC_CHECK_SIZEOF(short,2)
dnl AC_CHECK_SIZEOF(int,4)
dnl AC_CHECK_SIZEOF(long,4)
dnl AC_C_BIGENDIAN
AC_TYPE_UID_T
AC_TYPE_OFF_T
AC_TYPE_SIZE_T
dnl AC_CHECK_BOOL

dnl from Samba configure.in

AC_CACHE_CHECK([for off64_t],samba_cv_HAVE_OFF64_T,[
AC_TRY_RUN([#include <stdio.h>
#include <sys/stat.h>
main() { struct stat64 st; off64_t s; if (sizeof(off_t) == sizeof(off64_t)) exit(1); exit((lstat64("/dev/null", &st)==0)?0:1); }],
samba_cv_HAVE_OFF64_T=yes,samba_cv_HAVE_OFF64_T=no,samba_cv_HAVE_OFF64_T=cross)])
if test x"$samba_cv_HAVE_OFF64_T" = x"yes"; then
    AC_DEFINE_UNQUOTED(HAVE_OFF64_T,1,[Define if you have off64_t])
fi

